# ステップ1
テーブル：channnels
| カラム名 | データ型 | NULL | キー | 初期値 | auto increment |
| --- | --- | --- | --- | --- | --- |
| id | bigint(20) | NO | PRIMARY |  | YES |
| name | varchar(100) | NO |  |  |  |

テーブル：programs
| カラム名 | データ型	| NULL | キー | 初期値 | auto increment |
| --- | --- | --- | --- | --- | --- |
|id	| bigint(20) | NO	| PRIMARY	|	YES |
|title | varchar(255) |	NO |		
|description | text	| YES |			
|is_series | boolean | NO | 0	|

テーブル：genres
| カラム名 | データ型	| NULL | キー | 初期値 | auto increment |
| --- | --- | --- | --- | --- | --- |
| id | bigint(20) | NO | PRIMARY |  | YES |
| name | varchar(100) | NO | UNIQUE |  |  |

・ユニークキー制約：nameカラムに対して設定

テーブル：program_genres
| カラム名 | データ型	| NULL | キー | 初期値 | auto increment |
| --- | --- | --- | --- | --- | --- |
| program_id | bigint(20) | NO | PRIMARY/FK |  |  |
| genre_id | bigint(20) | NO | PRIMARY/FK |  |  |

・外部キー制約：program_id に対して、programs テーブルの id カラムから設定
・外部キー制約：genre_id に対して、genres テーブルの id カラムから設定

テーブル：seasons
| カラム名 | データ型	| NULL | キー | 初期値 | auto increment |
| --- | --- | --- | --- | --- | --- |
| id | bigint(20) | NO | PRIMARY |  | YES |
| program_id | bigint(20) | NO | FK |  |  |
| season_number | int | NO | UNIQUE |  |  |

・外部キー制約：program_id に対して、programs テーブルの id カラムから設定
・ユニークキー制約：season_numberカラムについて、program_idと組み合わせて設定

テーブル：episodes
| カラム名 | データ型	| NULL | キー | 初期値 | auto increment |
| --- | --- | --- | --- | --- | --- |
| id | bigint(20) | NO | PRIMARY |  | YES |
| program_id | bigint(20) | NO | FK |  |  |
| season_id | bigint(20) | YES | FK |  |  |
| episode_number | int | YES |  |  |  |
| title | varchar(255) | NO |  |  |  |
| description | text | YES |  |  |  |
| duration_seconds | int | NO |  |  |  |
| published_at | datetime | NO |  |  |  |

・外部キー制約：program_id に対して、programs テーブルの id カラムから設定
・外部キー制約：season_id に対して、seasons テーブルの id カラムから設定


テーブル：program_slots
| カラム名 | データ型	| NULL | キー | 初期値 | auto increment |
| --- | --- | --- | --- | --- | --- |
| id | bigint(20) | NO | PRIMARY |  | YES |
| channel_id | bigint(20) | NO | FK |  |  |
| start_time | datetime | NO |  |  |  |
| end_time | datetime | NO |  |  |  |

・外部キー制約：channel_id に対して、channels テーブルの id カラムから設定


テーブル：broadcasts
| カラム名 | データ型	| NULL | キー | 初期値 | auto increment |
| --- | --- | --- | --- | --- | --- |
| id | bigint(20) | NO | PRIMARY |  | YES |
| program_slot_id | bigint(20) | NO | FK |  |  |
| episode_id | bigint(20) | NO | FK |  |  |
| view_count | bigint(20) | YES |  |  |  |

・外部キー制約：program_slot_id に対して、program_slots テーブルの id カラムから設定
・外部キー制約：episode_id に対して、episodes テーブルの id カラムから設定



カラム名
# ステップ2
## 1.データベースの構築
初めにデータベースの構築をします。  
MySQL等のDBMSにログインし、次のコードを書きます。
```sql
create database internet_tv;
```
次に使用するデータベースを選択します。
```sql
use internet_tv;
```

## 2.テーブルの構築
ステップ1で設計したテーブルを依存関係の順番で作成していきます。
### チャンネルテーブル
```sql
CREATE TABLE channels (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) NOT NULL
);
```

### 番組テーブル
```sql
CREATE TABLE programs (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  is_series BOOLEAN NOT NULL DEFAULT 0
);
```

### ジャンルテーブル
```sql
CREATE TABLE genres (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) NOT NULL UNIQUE
);
```

### 番組とジャンルの中間テーブル
```sql
CREATE TABLE program_genres (
  program_id BIGINT NOT NULL,
  genre_id BIGINT NOT NULL,
  PRIMARY KEY (program_id, genre_id),
  FOREIGN KEY (program_id) REFERENCES programs(id),
  FOREIGN KEY (genre_id) REFERENCES genres(id)
);
```

### シーズンテーブル
```sql
CREATE TABLE seasons (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  program_id BIGINT NOT NULL,
  season_number INT NOT NULL,
  UNIQUE (program_id, season_number),
  FOREIGN KEY (program_id) REFERENCES programs(id)
);
```

### エピソードテーブル
```sql
CREATE TABLE episodes (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  program_id BIGINT NOT NULL,
  season_id BIGINT,
  episode_number INT,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  duration_seconds INT NOT NULL,
  published_at DATETIME NOT NULL,
  FOREIGN KEY (program_id) REFERENCES programs(id),
  FOREIGN KEY (season_id) REFERENCES seasons(id)
);
```

### 番組枠テーブル
```sql
CREATE TABLE program_slots (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  channel_id BIGINT NOT NULL,
  start_time DATETIME NOT NULL,
  end_time DATETIME NOT NULL,
  FOREIGN KEY (channel_id) REFERENCES channels(id)
);
```

### 放送テーブル（番組枠 × エピソード）
```sql
CREATE TABLE broadcasts (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  program_slot_id BIGINT NOT NULL,
  episode_id BIGINT NOT NULL,
  view_count BIGINT NULL,
  FOREIGN KEY (program_slot_id) REFERENCES program_slots(id),
  FOREIGN KEY (episode_id) REFERENCES episodes(id)
);
```

## 3.サンプルデータ投入
サンプルデータを投入します。
### チャンネル
```sql
INSERT INTO channels VALUES
(1, 'ドラマ'),
(2, 'アニメ'),
(3, 'スポーツ');
```

### ジャンル
```sql
INSERT INTO genres VALUES
(1, 'ドラマ'),
(2, 'アニメ'),
(3, 'スポーツ');
```

### 番組
```sql
INSERT INTO programs VALUES
(1, '半沢直樹', '銀行員の逆転劇', 1),
(2, 'リーガルハイ', '型破りな弁護士ドラマ', 1),
(3, '鬼滅の刃', '鬼と戦う剣士の物語', 1),
(4, '進撃の巨人', '巨人との戦い', 1),
(5, 'サッカー名勝負集', '歴史的名試合', 1);
```

### 番組とジャンル
```sql
INSERT INTO program_genres VALUES
(1, 1), (2, 1),
(3, 2), (4, 2),
(5, 3);
```

### シーズン
```sql
INSERT INTO seasons VALUES
(1, 1, 1),
(2, 2, 1),
(3, 3, 1),
(4, 4, 1),
(5, 5, 1);
```

### エピソード
```sql
INSERT INTO episodes VALUES
(1, 1, 1, 1, '半沢1話', '倍返しの始まり', 2700, '2024-01-01'),
(2, 1, 1, 2, '半沢2話', '逆転劇', 2700, '2024-01-02'),
(3, 2, 2, 1, 'リーガル1話', '型破り弁護士', 2600, '2024-01-01'),
(4, 2, 2, 2, 'リーガル2話', '裁判バトル', 2600, '2024-01-02'),
(5, 3, 3, 1, '残酷', '第1話', 1500, '2024-01-01'),
(6, 3, 3, 2, '育手', '第2話', 1500, '2024-01-02'),
(7, 4, 4, 1, '人類の危機', '第1話', 1500, '2024-01-01'),
(8, 4, 4, 2, '反撃', '第2話', 1500, '2024-01-02'),
(9, 5, 5, 1, 'W杯決勝', '名勝負', 3600, '2024-01-03');
```

### 番組枠
```sql
INSERT INTO program_slots VALUES
-- 過去
(1, 1, CURDATE() - INTERVAL 6 DAY + INTERVAL 21 HOUR, CURDATE() - INTERVAL 6 DAY + INTERVAL 21 HOUR + INTERVAL 45 MINUTE),
(2, 1, CURDATE() - INTERVAL 3 DAY + INTERVAL 21 HOUR, CURDATE() - INTERVAL 3 DAY + INTERVAL 21 HOUR + INTERVAL 45 MINUTE),
(3, 2, CURDATE() - INTERVAL 2 DAY + INTERVAL 19 HOUR, CURDATE() - INTERVAL 2 DAY + INTERVAL 19 HOUR + INTERVAL 30 MINUTE),
(4, 3, CURDATE() - INTERVAL 1 DAY + INTERVAL 20 HOUR, CURDATE() - INTERVAL 1 DAY + INTERVAL 21 HOUR),

-- 未来
(5, 1, CURDATE() + INTERVAL 21 HOUR, CURDATE() + INTERVAL 21 HOUR + INTERVAL 45 MINUTE),
(6, 1, CURDATE() + INTERVAL 1 DAY + INTERVAL 21 HOUR, CURDATE() + INTERVAL 1 DAY + INTERVAL 21 HOUR + INTERVAL 45 MINUTE),
(7, 1, CURDATE() + INTERVAL 2 DAY + INTERVAL 21 HOUR, CURDATE() + INTERVAL 2 DAY + INTERVAL 21 HOUR + INTERVAL 45 MINUTE),
(8, 1, CURDATE() + INTERVAL 3 DAY + INTERVAL 21 HOUR, CURDATE() + INTERVAL 3 DAY + INTERVAL 21 HOUR + INTERVAL 45 MINUTE);
```

### 放送
```sql
INSERT INTO broadcasts VALUES
-- 過去（視聴数あり）
(1, 1, 1, 220000),
(2, 2, 2, 210000),
(3, 3, 5, 250000),
(4, 4, 9, 260000),

-- 未来（視聴数なし）
(5, 5, 1, NULL),
(6, 6, 2, NULL),
(7, 7, 3, NULL),
(8, 8, 4, NULL);
```

# ステップ3
以下のデータを抽出するクエリです。
#### 1.よく見られているエピソード(エピソード視聴数トップ3のエピソードタイトルと視聴数)
```sql
select
 episodes.title as 'エピソードタイトル',
 broadcasts.view_count as '視聴数'
from broadcasts
join episodes
  on broadcasts.episode_id = episodes.id
order by broadcasts.view_count desc
limit 3;
```
#### 2.よく見られているエピソードの番組情報やシーズン情報(エピソード視聴数トップ3の番組タイトル、シーズン数、エピソード数、エピソードタイトル、視聴数)
```sql
select
 p.title as '番組タイトル',
 s.season_number as 'シーズン数',
 e.episode_number as 'エピソード数',
 e.title as 'エピソードタイトル',
 b.view_count as '視聴数'
from broadcasts as b
join episodes e
  on b.episode_id = e.id
join seasons as s
  on e.season_id = s.id
join programs as p
  on e.program_id = p.id
order by b.view_count desc
limit 3;
```

#### 3.本日の番組表(本日放送される全ての番組のチャンネル名、放送開始時刻(日付+時間)、放送終了時刻、シーズン数、エピソード数、エピソードタイトル、エピソード詳細)
```sql
select
 c.name as 'チャンネル名',
 p.start_time as '放送開始時刻',
 p.end_time as '放送終了時刻',
 s.season_number as 'シーズン数',
 e.episode_number as 'エピソード数',
 e.title as 'エピソードタイトル',
 e.description as 'エピソード詳細'
from broadcasts as b
join program_slots as p
  on b.program_slot_id = p.id
join episodes as e
  on b.episode_id = e.id
join seasons as s
  on e.season_id = s.id
join channels as c
  on p.channel_id = c.id
where p.start_time >= curdate()
  and p.start_time < date_add(curdate(), interval 1 day);
```

#### 4.一週間分のドラマのチャンネルの番組表(ドラマのチャンネルに対して、放送開始時刻、放送終了時刻、シーズン数、エピソード数、エピソードタイトル、エピソード詳細)

```sql
select
  p.start_time as '放送開始時刻',
  p.end_time as '放送終了時刻',
  s.season_number as 'シーズン数',
  e.episode_number as 'エピソード数',
  e.title as 'エピソードタイトル',
  e.description as 'エピソード詳細'
from broadcasts as b
join program_slots as p
  on b.program_slot_id = p.id
join episodes as e
  on b.episode_id = e.id
join seasons as s
  on e.season_id = s.id
join channels as c
  on p.channel_id = c.id
where c.name = 'ドラマ'
  and p.start_time >= curdate()
  and p.start_time < date_add(curdate(), interval 7 day);
```

#### 5.直近一週間で見られた番組トップ2(直近一週間に放送された番組の中で、エピソード視聴数合計トップ2の番組に対して、番組タイトル、視聴数)
```sql
select
 p.title as '番組タイトル',
 sum(b.view_count) as '視聴数'
from broadcasts as b
join program_slots as ps
  on b.program_slot_id = ps.id
join episodes as e
  on b.episode_id = e.id
join programs as p
  on e.program_id = p.id
where ps.start_time >= date_add(curdate(), interval -7 day)
  and ps.start_time < curdate()
group by p.title
order by 視聴数 desc
limit 2;
```

#### 6.ジャンルごとの番組の視聴数ランキング(ジャンルごとに視聴数トップの番組に対する、ジャンル名、番組タイトル、エピソード平均視聴数)
```sql
select
  t.genre_name as 'ジャンル名',
  t.program_title as '番組タイトル',
  t.avg_view_count as 'エピソード平均視聴数'
from (
  select
    g.id as genre_id,
    g.name as genre_name,
    p.title as program_title,
    round(avg(b.view_count)) as avg_view_count,
    rank() over (
      partition by g.id
      order by avg(b.view_count) desc
    ) as rnk
  from broadcasts b
  join episodes e
    on b.episode_id = e.id
  join programs p
    on e.program_id = p.id
  join program_genres pg
    on p.id = pg.program_id
  join genres g
    on pg.genre_id = g.id
  group by
    g.id,
    g.name,
    p.id,
    p.title
) t
where t.rnk = 1;
```
