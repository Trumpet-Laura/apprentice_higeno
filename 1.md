# ステップ2
## 1.データベースの構築
初めにデータベースの構築をします。  
MySQL等のDBMSにログインし、次のコードを書きます。
```sql
create database internet_tv;
```
次に使用するデータベースを選択します。
```sql
use internet_tv;
```

## 2.テーブルの構築
ステップ1で設計したテーブルを依存関係の順番で作成していきます。
### チャンネルテーブル
```sql
CREATE TABLE channels (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) NOT NULL
);
```

### 番組テーブル
```sql
CREATE TABLE programs (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  is_series BOOLEAN NOT NULL DEFAULT 0
);
```

### ジャンルテーブル
```sql
CREATE TABLE genres (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) NOT NULL UNIQUE
);
```

### 番組とジャンルの中間テーブル
```sql
CREATE TABLE program_genres (
  program_id BIGINT NOT NULL,
  genre_id BIGINT NOT NULL,
  PRIMARY KEY (program_id, genre_id),
  FOREIGN KEY (program_id) REFERENCES programs(id),
  FOREIGN KEY (genre_id) REFERENCES genres(id)
);
```

### シーズンテーブル
```sql
CREATE TABLE seasons (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  program_id BIGINT NOT NULL,
  season_number INT NOT NULL,
  UNIQUE (program_id, season_number),
  FOREIGN KEY (program_id) REFERENCES programs(id)
);
```

### エピソードテーブル
```sql
CREATE TABLE episodes (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  program_id BIGINT NOT NULL,
  season_id BIGINT,
  episode_number INT,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  duration_seconds INT NOT NULL,
  published_at DATETIME NOT NULL,
  FOREIGN KEY (program_id) REFERENCES programs(id),
  FOREIGN KEY (season_id) REFERENCES seasons(id)
);
```

### 番組枠テーブル
```sql
CREATE TABLE program_slots (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  channel_id BIGINT NOT NULL,
  start_time DATETIME NOT NULL,
  end_time DATETIME NOT NULL,
  FOREIGN KEY (channel_id) REFERENCES channels(id)
);
```

### 放送テーブル（番組枠 × エピソード）
```sql
CREATE TABLE broadcasts (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  program_slot_id BIGINT NOT NULL,
  episode_id BIGINT NOT NULL,
  view_count BIGINT NULL,
  FOREIGN KEY (program_slot_id) REFERENCES program_slots(id),
  FOREIGN KEY (episode_id) REFERENCES episodes(id)
);
```

## 3.サンプルデータ投入
サンプルデータを投入します。
### チャンネル
```sql
INSERT INTO channels VALUES
(1, 'ドラマ'),
(2, 'アニメ'),
(3, 'スポーツ');
```

### ジャンル
```sql
INSERT INTO genres VALUES
(1, 'ドラマ'),
(2, 'アニメ'),
(3, 'スポーツ');
```

### 番組
```sql
INSERT INTO programs VALUES
(1, '半沢直樹', '銀行員の逆転劇', 1),
(2, 'リーガルハイ', '型破りな弁護士ドラマ', 1),
(3, '鬼滅の刃', '鬼と戦う剣士の物語', 1),
(4, '進撃の巨人', '巨人との戦い', 1),
(5, 'サッカー名勝負集', '歴史的名試合', 1);
```

### 番組とジャンル
```sql
INSERT INTO program_genres VALUES
(1, 1), (2, 1),
(3, 2), (4, 2),
(5, 3);
```

### シーズン
```sql
INSERT INTO seasons VALUES
(1, 1, 1),
(2, 2, 1),
(3, 3, 1),
(4, 4, 1),
(5, 5, 1);
```

### エピソード
```sql
INSERT INTO episodes VALUES
(1, 1, 1, 1, '半沢1話', '倍返しの始まり', 2700, '2024-01-01'),
(2, 1, 1, 2, '半沢2話', '逆転劇', 2700, '2024-01-02'),
(3, 2, 2, 1, 'リーガル1話', '型破り弁護士', 2600, '2024-01-01'),
(4, 2, 2, 2, 'リーガル2話', '裁判バトル', 2600, '2024-01-02'),
(5, 3, 3, 1, '残酷', '第1話', 1500, '2024-01-01'),
(6, 3, 3, 2, '育手', '第2話', 1500, '2024-01-02'),
(7, 4, 4, 1, '人類の危機', '第1話', 1500, '2024-01-01'),
(8, 4, 4, 2, '反撃', '第2話', 1500, '2024-01-02'),
(9, 5, 5, 1, 'W杯決勝', '名勝負', 3600, '2024-01-03');
```

### 番組枠
```sql
INSERT INTO program_slots VALUES
-- 過去
(1, 1, CURDATE() - INTERVAL 6 DAY + INTERVAL 21 HOUR, CURDATE() - INTERVAL 6 DAY + INTERVAL 21 HOUR + INTERVAL 45 MINUTE),
(2, 1, CURDATE() - INTERVAL 3 DAY + INTERVAL 21 HOUR, CURDATE() - INTERVAL 3 DAY + INTERVAL 21 HOUR + INTERVAL 45 MINUTE),
(3, 2, CURDATE() - INTERVAL 2 DAY + INTERVAL 19 HOUR, CURDATE() - INTERVAL 2 DAY + INTERVAL 19 HOUR + INTERVAL 30 MINUTE),
(4, 3, CURDATE() - INTERVAL 1 DAY + INTERVAL 20 HOUR, CURDATE() - INTERVAL 1 DAY + INTERVAL 21 HOUR),

-- 未来
(5, 1, CURDATE() + INTERVAL 21 HOUR, CURDATE() + INTERVAL 21 HOUR + INTERVAL 45 MINUTE),
(6, 1, CURDATE() + INTERVAL 1 DAY + INTERVAL 21 HOUR, CURDATE() + INTERVAL 1 DAY + INTERVAL 21 HOUR + INTERVAL 45 MINUTE),
(7, 1, CURDATE() + INTERVAL 2 DAY + INTERVAL 21 HOUR, CURDATE() + INTERVAL 2 DAY + INTERVAL 21 HOUR + INTERVAL 45 MINUTE),
(8, 1, CURDATE() + INTERVAL 3 DAY + INTERVAL 21 HOUR, CURDATE() + INTERVAL 3 DAY + INTERVAL 21 HOUR + INTERVAL 45 MINUTE);
```

### 放送
```sql
INSERT INTO broadcasts VALUES
-- 過去（視聴数あり）
(1, 1, 1, 220000),
(2, 2, 2, 210000),
(3, 3, 5, 250000),
(4, 4, 9, 260000),

-- 未来（視聴数なし）
(5, 5, 1, NULL),
(6, 6, 2, NULL),
(7, 7, 3, NULL),
(8, 8, 4, NULL);
```

# ステップ3
以下のデータを抽出するクエリ
#### 1.エピソード視聴数トップ3のエピソードタイトルと視聴数
```sql
select
episodes.title, episode_views.view_count
from
episode_views
join
broadcasts
on
episode_views.broadcast_id = broadcasts.id
join 
episodes 
on
broadcasts.episode_id = episodes.id
order by episode_views.view_count desc limit 3;
```
#### 2.エピソード視聴数トップ3の番組タイトル、シーズン数、エピソード数、エピソードタイトル、視聴数
```sql
select programs.title as program_title, seasons.season_number, episodes.episode_number, episodes.title as episode_title, episode_views.view_count
from episode_views
join broadcasts
on episode_views.broadcast_id = broadcasts.id
join episodes
on broadcasts.episode_id = episodes.id
join seasons
on episodes.season_id = seasons.id
join programs
on episodes.program_id = programs.id
order by episode_views.view_count desc limit 3;
```

#### 3.本日の番組表(本日放送される全ての番組のチャンネル名、放送開始時刻(日付+時間)、放送終了時刻、シーズン数、エピソード数、エピソードタイトル、エピソード詳細)
```sql
select channels.name as '番組名', program_slots.start_time as '放送開始時刻', program_slots.end_time as '放送終了時刻', seasons.season_number as 'シーズン数', episodes.episode_number as 'エピソード数', episodes.title as 'エピソードタイトル', episodes.description as 'エピソード詳細'
from broadcasts
join program_slots on broadcasts.program_slot_id = program_slots.id
join episodes on broadcasts.episode_id = episodes.id
join seasons on episodes.season_id = seasons.id
join channels on program_slots.channel_id = channels.id
where start_time like '2026-01-27%';
```
